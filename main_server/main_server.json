{
    "_readme": [
        "The AMI used is generated by the packer template base/base.json",
        ""
    ],
    "variables": {
        "ami_name": "main_server",
        "ami_base": "{{env `AMI_BASE`}}",
        "ami_sha": "{{env `SHA`}}",
        "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
        "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}",
        "region": "{{env `REGION`}}",
        "subnet_id": "{{env `SUBNET_ID`}}"
    },
    "builders": [
        {
            "ami_description": "{{user `ami_name`}} AMI",
            "ami_name": "{{user `ami_name`}} {{timestamp}}",
            "ami_regions": [
                "{{user `region`}}"
            ],
            "instance_type": "t3.small",
            "region": "{{user `region`}}",
            "run_tags": {
                "ami-create": "{{user `ami_name`}}"
            },
            "source_ami": "{{user `ami_base`}}",
            "ssh_username": "ubuntu",
            "subnet_id": "{{user `subnet_id`}}",
            "tags": {
                "OS_Name": "Ubuntu",
                "OS_Version": "18.04",
                "SHA": "{{user `ami_sha`}}",
                "ami": "{{user `ami_name`}}",
                "base_ami": "{{user `ami_base`}}",
                "type": "main_server"
            },
            "type": "amazon-ebs"
        }
    ],
    "provisioners": [
        {
            "inline": [
                "echo 'Waiting for cloud-init...'",
                "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done",
                "sleep 10"
            ],
            "type": "shell"
        },
        {
            "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E {{ .Path }}",
            "scripts": [
                "./main_server/tasks/docker.sh",
                "./main_server/tasks/beanstalkd.sh",
                "./main_server/tasks/openresty.sh",
                "./main_server/tasks/php.sh",
                "./main_server/tasks/filebeat.sh",
                "./main_server/tasks/dehydrated.sh",
                "./main_server/tasks/deploy_scripts.sh",
                "./main_server/tasks/opcache_gui.sh"
            ],
            "type": "shell"
        },
        {
            "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E {{ .Path }}",
            "scripts": [
                "./base/tasks/debug.sh",
                "./base/tasks/cleanup.sh"
            ],
            "type": "shell"
        }
    ],
    "post-processors": [
        {
            "output": "manifest-main_server.json",
            "strip_path": true,
            "type": "manifest"
        }
    ]
}